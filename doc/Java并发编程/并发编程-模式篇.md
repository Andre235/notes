#### 两阶段终止线程模式

##### 问题描述

如何在线程T1**优雅**地终止线程T2，这里优雅指的是给线程T2*料理后事*（**释放锁**）的机会

##### 错误思路

1. 使用线程的`stop方法`停止线程

   stop方法会真正地杀死线程，如果这个时候线程锁住了**共享资源**，那么当它被杀死以后就再也**没有机会释放锁**了，其他线程也就永远无法获取锁

2. 使用System.exit() 方法停止线程

   我们的需求是仅仅停止一个线程，但是这种方法会让整个进程都停止

##### 两阶段终止模式流程图

<img src="https://i.loli.net/2021/06/20/YJB7mHMwfQr6gOP.png" alt="image-20210620115536922" style="zoom:80%;" />

```java
@Slf4j(topic = "Test13Interrupt")
public class Test13Interrupt {
    public static void main(String[] args) throws InterruptedException {
        TwoPhaseTermination twoPhaseTermination = new TwoPhaseTermination();

        twoPhaseTermination.start();

        // 3.5秒以后 打断监控线程
        TimeUnit.MILLISECONDS.sleep(3500);
        twoPhaseTermination.stop();
    }
}


@Slf4j(topic = "TwoPhaseTermination")
class TwoPhaseTermination {
    /**
     * 监控线程
     */
    private Thread monitorThread;

    /**
     * 启动监控线程
     */
    public void start() {
        monitorThread = new Thread(() -> {
            while (true) {
                Thread currentThread = Thread.currentThread();
                boolean isInterrupted = currentThread.isInterrupted();
                if(isInterrupted) {
                    log.info("监控线程被打断，料理后事，正常退出...");
                    break;
                }else {
                    try {
                        // 情况1： 在睡眠过程中被打断
                        TimeUnit.SECONDS.sleep(1);

                        // 情况2： 在正常执行监控任务过程中被打断
                        log.info("执行监控任务");

                    } catch (InterruptedException e) {
                        e.printStackTrace();
                        // 当程序处于睡眠阻塞状态时，这时候对其打断，打断标记为假，我们需要手动设置打断标记为真
                        currentThread.interrupt();
                    }
                }
            }
        });
        monitorThread.start();
    }

    /**
     * 停止监控线程
     */
    public void stop() {
        monitorThread.interrupt();
    }
}


12:22:40.516 [Thread-0] INFO TwoPhaseTermination - 执行监控任务
12:22:41.521 [Thread-0] INFO TwoPhaseTermination - 执行监控任务
12:22:42.521 [Thread-0] INFO TwoPhaseTermination - 执行监控任务
java.lang.InterruptedException: sleep interrupted
	at java.lang.Thread.sleep(Native Method)
	at java.lang.Thread.sleep(Thread.java:340)
	at java.util.concurrent.TimeUnit.sleep(TimeUnit.java:386)
	at com.kuhan.ops.monitor.system.TwoPhaseTermination.lambda$start$0(Test13Interrupt.java:47)
	at java.lang.Thread.run(Thread.java:748)
12:22:43.014 [Thread-0] INFO TwoPhaseTermination - 监控线程被打断，料理后事，正常退出...
```



